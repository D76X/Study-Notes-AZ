# AZ-203-04-01

## [Develop Azure Platform as Service Compute Solutions (20-25%)](https://www.microsoft.com/en-us/learning/exam-az-203.aspx)

Implement authentication

- implement authentication by using certificates, forms-based authentication, or tokens
- implement multi-factor or Windows authentication by using Azure AD
- implement OAuth2 authentication
- implement Managed Service Identity (MSI)/Service Principal authentication 

---

### Main Resources  

1. [Microsoft Azure Authentication Scenarios for Developers by Sahil Malik](https://app.pluralsight.com/library/courses/microsoft-azure-authentication-scenarios-developers/table-of-contents) 

2. [Azure AD for Developers](https://app.pluralsight.com/library/courses/azure-active-directory-developers/table-of-contents)  

3. [Design Authentication for Microsoft Azure by John Savill](https://app.pluralsight.com/library/courses/microsoft-azure-authentication-design/table-of-contents)  

4. [Managing Microsoft Azure Information Protection by Ned Bellavance](https://app.pluralsight.com/library/courses/microsoft-azure-information-protection-managing/table-of-contents)  
5. [Managing Microsoft Azure Subscriptions by Daniel Lachance](https://app.pluralsight.com/library/courses/microsoft-azure-subscriptions-managing/table-of-contents)    

6. [Implementing Managed Identities for Microsoft Azure Resources by Manoj Nair](https://app.pluralsight.com/library/courses/microsoft-azure-resources-managed-identities-implementing/table-of-contents) 

7. [Implementing and Managing Azure Multi-factor Authentication by Neil Morrissey](https://app.pluralsight.com/library/courses/azure-multi-factor-authentication-implementing-managing/table-of-contents)  

8. [Managing Identities in Microsoft Azure Active Directory by Ned Bellavance](https://app.pluralsight.com/library/courses/microsoft-azure-active-directory-managing-identities/table-of-contents)

9. [Microsoft Hybrid Identity - Overview by Gary Grudzinskas](https://app.pluralsight.com/library/courses/microsoft-hybrid-identity-overview/table-of-contents)   

10. [Implementing Microsoft Azure Privileged Identity Management by Ammar Hasayen](https://app.pluralsight.com/library/courses/microsoft-azure-privileged-identity-management-implementing/table-of-contents)  

### Related Resources  

1. [Managing Microsoft Azure App Service Protection by Benjamin Culbertson](https://app.pluralsight.com/library/courses/microsoft-azure-app-service-protection-managing/table-of-contents)  

2. [Securing Virtual Machines with Azure Key Vault by Gary Grudzinskas](https://app.pluralsight.com/library/courses/securing-virtual-machines-azure-key-vault/table-of-contents)   

3. [Using Microsoft Azure Resource Groups by Gary Grudzinskas](https://app.pluralsight.com/library/courses/microsoft-azure-resource-groups-using/table-of-contents)  

4. [Managing Microsoft Azure Subscriptions by Dan Lachance](https://app.pluralsight.com/library/courses/microsoft-azure-subscriptions-managing/table-of-contents)   

### Supplementary Resources  

1. [How SAML, OAUTH, and other Identity Federation Solutions Work in a Windows Enterprise](https://www.youtube.com/watch?v=GJyyVjzQ4a0)  

2. [Azure AD Federation Fundamentals](https://www.youtube.com/watch?v=8ioiDrjI0Z4)  

3. [Understanding Active Directory Federation Services an Introduction](https://www.youtube.com/watch?v=xwWb7S6OvFI)  

4. [How SSL works tutorial - with HTTPS example](https://www.youtube.com/watch?v=iQsKdtjwtYI)

5. [Breaking Down the TLS Handshake](https://www.youtube.com/watch?v=cuR05y_2Gxc)  

6. [JWT](https://jwt.io/)  
JSON Web Tokens are an open, industry standard RFC 7519 method for representing claims securely between two parties. JWT.IO allows you to decode, verify and generate JWT.

---

### [What is Active Directory Federation Services (ADFS)](https://www.youtube.com/watch?v=xwWb7S6OvFI)  

- AFDS is an **integrated** **claim-based identity management solution**.
- Provides **SSO** for web applications.
- Send **claims** to a web application **on behalf of AD**.
- helps to **support web service interoperability** between vendors.

### The most common authentication mechanics used by ADFS - SAML 2.0

When a request at the URL of a reource or service is received it replies to the request (from the browser) with a **HTTP 302 URL redirection to the URL of the on-premise ADFS server**.

The **on-premise ADFS server**  receives the **authentication request** from the user's browser **for the cloud service or resource** the user tried to access. It then **authenticates** the user against the **on-premise AD Service** and replies to the uthentication request from the user's browser with **a set of claims for the authenticated user and the cloud resource that the user tried to access** all wrapped-up in a **cookie**.

Finally the user brower is redirected by the **ADFS HTTP 302 response** back to the same URL of the cloud resource or service it wanted to access in the first place but this time it is able to present its **identity and the claims for the requested cloud service or resource**.

### Credentials are never exposed to the cloud 

One of **the most important facts** to keep in mind about the mechanics of ADFS is that users who want or need to access resources or services made available in the cloud are **never** requested to provide any credentials to any part of the cloud infrastructure at the time they attempt to consume those services. **Users are authenticated entirely on premise and any username o passoword** inputted by users in their browser are aonly transmitted to the ADFS Server and then relayed to AD and are kept within the confine of the enterprise IT infrastructure.

### Attributes included in the claim

The **claim-based** cookie that is presented to the cloud resource at the end of the authentication process is **agreed in advance** between the cloud service and the ADFS Server. Claims might be a set of information tokes such as **Firstname, Lastname, email adress, department, etc.**. 

---

### [What is Azure AD and why do we need it?](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=1&mode=live)    

### [What are the limits of Active Direcory (AD)?](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=81397afd-a564-4afd-826d-07968d4f5e4f&clip=1&mode=live)  

In the **Windows Ecosystem** **Authentication is implemented by means of the long standing Active Directory (AD)**. However, **AD does not scale well** in all cases that involves actors who might need to authenticate from outside the boundaries of the organization.

These cases have become predominant in all secotrs of industry. The list below shows a sample of typical user cases in which authentication must be performed for someone who is physically located outside the organization premises.

- Agents, Salespeople, etc. with a **mobile device** who need to access on-premise services.
- Third part contractors who might need to access on-premise resources.
- Individuals who are part of the resident staff of the organization but are allowed to perform **remote working**.

Any of these scenarios has **already** its own solution with traditional techniques which **extend the traditional AD such as Federation or VPN Tunnel or adhoc accounts**. However, in all cases there is **limited flexibility and increase complexity and costs in addition to several technical problems** which mak it hard to set-up, configure and maintain such solutions.

**Azure AD** has been designed from the ground up to adress also these problems among others whic are appened in the list below.

### [Problems with AD](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=1&mode=live)  

- Authentications scenarios have gone beyond the simple case of the on-premise user PC with the advent of mobile devices, remote working, cloud services.
- AD represent a single point of failure whithin the organization i.e. if the AD controller went down then there would not be any email, Outlook, Sharepoint, etc.
- On-premise Active Directory si not designed for Internet scale above all because teh main design is based on a hierarchy of trust that does not traslate at all to the reality of cloud services and intergation with third-party services and APIs.
- The amount of information exchanged to teh purpose of authentication between the user's PC and the AD Controller is large and the process is repeated seberal time. While this is OK with the on-premise infrastructure it is not suitable for authentication protocols that must take place over the Internet (public infrastructure). 

### [How Azure AD solves these problems](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=1&mode=live)  

- Azure AD is designed from the ground up to provide **Authentication Services** **built on standard protocols already in use over the Internet (OAuth1/2, SAML. PKCE, WS-Federation, etc.)** and therefore able to scale in those scenarios.

---

The following table illustrates the corrispondence betwenn traditional AD technologies and some of the solution that allow to achieve the same result but are independent of AD and are therefore more scalable.


| AD                      | Open Solutions             |
| ----------------------- | -------------------------- |
| `Group Policies`  | Mobile Device Management (MDM) |  
| `Kerbeors/NTML`   | OpenID & OAuth |
| `Session Based Security` | Acess Tokens & Refresh Tokens |

---

## [Azure AD](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=81397afd-a564-4afd-826d-07968d4f5e4f&clip=2&mode=live)   

[**Azure AD** is an **entirely new** product that is **independent of AD**, although it can easily work together with AD.](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=1&mode=live)  

- It is suitable for the cloud.
- Supports modern Authentication Protocols i.e. OpenID & OAuth.
- Provides **SDKs for almost any platform**.
- Supports **B2C, B2B and B2E** authentication.
- There are numerous SaaS Applications that integrate with Azure AD already available on teh marketplace.
- It is **completely free** for any organization to use as the **defacto standard for Authorization**, officially with a limit of 500.000 users which can be lifted, for free, if necessary.
- it is the **Authentication mechanism usedby Office 365** and therefore already in place in most organizations.

---

### [Azure AD Connect](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=81397afd-a564-4afd-826d-07968d4f5e4f&clip=2&mode=live)  

[Azure AD Connect](https://www.microsoft.com/en-us/download/details.aspx?id=47594) is a tool that allows organization to easily migrate from their on-premise AD to Azure AD. There are essentially two ways in which such migration can be [achieved](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=2&mode=live) .

1. AD identities and the Authentication service are both migrated to the cloud. 

2. The AD identiites are migrated to Azure AD but the authentication service remains on premise and AD Azure Authentication **federates the authentication to the on premise AD Authentication Service (ADFS)**.

When the migration strategy is to transfer the AD credential to Azure AD then the **Azure AD Connect** tool can do so by passing the hash of the password stored in AD on-premise directly as it is or as a new hash of this hash. In the latter case AD Azure remains oblivion of the original hash and merely provides Authentication Services on behalf of the on-premise AD Controller.

---

## [Authentication Scenarios](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=81397afd-a564-4afd-826d-07968d4f5e4f&clip=4&mode=live)  

- Form-based Authentication
- Business to Consumer (B2C) Authentication
- Token-based Authentication to SQL
- Multi-Factor Authentication (MFA)
- Certificate-based Authentication

---

## [Form-based Authentication](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=1588d422-3e09-4635-96cc-353b5e6bca48&clip=0&mode=live)  

This scenario is the simple case in which a user needs to authenticate to a service through a web form by providing their own AD credentials.

[Form-based Authentication can in general be achieved by one of the following mecanisms.](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=1588d422-3e09-4635-96cc-353b5e6bca48&clip=1&mode=live)  

### [Impotant Protocols](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=1588d422-3e09-4635-96cc-353b5e6bca48&clip=2&mode=live)  

1. WS-Federation
2. SAMLP - Security Assertion Markup Language Protocol
3. OpenID Connect 
4. OAuth2 Implicit Flow - suitable for SPAs
5. Authorization Code Grant Flow - suitable for Native Apps
6. Proof of Key Exchange (PKCE) flow - suitable for mobile apps

---

## Protocols bit by bit 

### 1. [The various flavour of **Federation & Claim-based Architecture**](https://www.youtube.com/watch?v=GJyyVjzQ4a0) [24:00]

### 2. [SAML vs AOuth](https://www.youtube.com/watch?v=GJyyVjzQ4a0) [30:00]

| SAML                      | OAuth                    |
| ------------------------- | ------------------------ |
| mostly for **SSO**        | mostly used for APIs |
| mostly browser            | browser and native apps |
| heavyweight digitally signed large XML | small JSON random token |
| mostly browser            | browser and native apps |
| expensive validation | simplevalidation|
| many security options | few security options |


### 3. [Kerbeors/NTML](https://www.youtube.com/watch?v=GJyyVjzQ4a0) [38:49]

---

## [Authentication Scenarios](https://app.pluralsight.com/player?course=microsoft-azure-authentication-scenarios-developers&author=sahil-malik&name=1588d422-3e09-4635-96cc-353b5e6bca48&clip=3&mode=live) 

The following are all typical Authentication scenarios and for each specific pattern, tools and practices are routinely employed in the IT industry. An in-deapth examinations of all of these scenarios is avalable in the course [Azure AD for Developers](https://app.pluralsight.com/library/courses/azure-active-directory-developers/table-of-contents). In the demos available in this course the author makes use of the [Azure AD Authentication Library (ADAL)](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=3&mode=live)
for the various platforms implied in the following authentication typical scenarios. 

- [Web Browser to Web App](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m2&clip=1&mode=live)
- [SPA to WebApi](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m3&clip=1&mode=live) - **must enable OAuth2 Implicit Grant Protocol**
- Native Apps to WebApi
- WebApp to WebApi under user credentials
- WebApp to WebApi using the App Identity
- [Deamon/Background Process](https://en.wikipedia.org/wiki/Daemon_(computing)) to WebApi   

It is useful to briefly expand on these scenarios which is done below. Moreover, it is important to remeber that all these authentication sceanrios **have their own authentication flow** which is what characterise each. It is therefore advisable to memorise the flow of each.  

---

#### Web Browser to Web App
This is the simple case of a user that from their web brower visits a page of a web site which requires the user to be authenticated in order to access the resource. For example, in the ASP.Net realm this would be the EP of a controller on which the [Authorize] attribute is applied. When **Azure AD** is used as **authentication provider** the
**web site** must be registered with Azure AD and must hold in its configuration the **authentication URL to which the user browser must be redirected to in order to authenticate**. 

1. With a web browser you visit the page of the site that requires authorization.
2. The web site cannot find the autorization token in the header of the request and **redirects (HTTP 302)** the browser to an **Azure AD endpoint registered for the web site**.
3. **Azure AD** responds to the browser request with a login page.
4. The user provides their credentials that are transimmted to **Azure AD over SSL**.
5. **Azure AD** uses the credential to authenticate the user or to **delegate to aother authentication parties i.e. a registered AFDS or third-party authenticaution server**.
6. If the client is authorized then **Azure AD** returns to them **authorization token** in the header of the reply and redirects them to teh original URL that the browser tried to access and has obtained a authorization token for. This token is embedded in the header of the new request made for this resource.
7. The web site receives the new request and this time finds the authorization token which the internal authentication logic of the server can use to verify that it actually comes from the the **Azure AD endpoint with which the site is registered and tha is a valid token**.
8. Finally, the requested resource is returned to the browser.  

---

#### SPA to WebApi
This is a very typical scenario in modern WebApps. Some JavaScript (or other language) for example a SPA or just some JavaScript embedded in a web app or native app or similar makes calls to a WebApi in order to retrieve information. **In these cases the caller plays the role of a native application** and it is **required that both the calling application and the WebApi are registered with Azure AD**. Further, in Azure AD **the calling application must be whitelisted for the WebApi** in order for the authentication flow to be performed correctly. One important detail is that both sides that is the native calling application and the WebAPi must hold in some kind of **config.json** some details about their registration with Azure AD and **must also explicitely enable OAuth2 Implicit Grant Protocol, which is disabled by default,** in order for this authentication flow to work. Lastly, in case the calling app is a WebApp that is aome JavaScript executing in a page of a browser download from some web site then **CORS may also play a part** as the web page in which the calling JavaScript is embedded might have come from a **domain that is not the domain of the WebApi that it makes calls to**. This is forbidden by default by any browser and must be explicitely authorized in the calling application i.e. SPA.

1. Download the native app from some domain or get it istalled on the user system. This native app is designe to make calls to a WebApi on a different domain (or same domain is some simpler cases) it has been downloaded from. If the application runs in a browser then the domain of the WebApis it needs to call must be enabled for CORS to let the browser allow the app to make the calls to them duriong its lifecycle.

2. The native app is registered in Azure ID and has a **Azure_AD_App_ID** provided by Azure AD. It needs to

---

#### Native Apps to WebApi
#### WebApp to WebApi under user credentials
#### WebApp to WebApi using the App Identity
#### Deamon/Background Process to WebApi

---

## [ADAL - Azure AD Authentication Library](https://app.pluralsight.com/player?course=azure-active-directory-developers&author=sahil-malik&name=azure-active-directory-developers-m1&clip=3&mode=live)  

ADAL is an open source library maintained by Microsoft.

All the aspects of Azure AD, the traditional AD and ADFS that ahev been discussed so far demonstrate how complex the theme of modern Authentication can be. 

There are typically two sides to take into account.

1. The processes and practices that must be implemented by the IT department to set up AD, ADFS and Azure AD according to the specific requirement of their organization.

2. The knowledge which developer must attain and maintain in order to make sure that the applications, APIs, web and cloud services they develop can properly authenticate by means of Azure AD.

While **the former is strictly dependent on the requirement imposed by the specific organization that intends to make use of Azure AD**, the latter is completely disjoint form such knowledge.

Developer of applications, APIs, web and cloud services or apps do not need to know anything about how the Azure AD Service they must make use of in order to authenticate has been set up in order to do so.

However, on the developer's side the complexity lies in the **multitude of available protocols in which authentication can be carried out between parties and Azure AD**. Such complexity can be appreciated by considering **the cross product between the available protocols and the type of parties**.

This has been already described in above but it is repeated below for 
convenience.

### Typical Authentication Scenarios 

- Web Browser to Web App
- SPA to WebApi
- Native Apps to WebApi
- WebApp to WebApi under user credentials
- WebApp to WebApi using the App Identity
- [Deamon/Background Process](https://en.wikipedia.org/wiki/Daemon_(computing)) to WebApi   

### Typical Authentication Technologies

1. WS-Federation
2. SAMLP - Security Assertion Markup Language Protocol
3. OpenID Connect 
4. OAuth2 Implicit Flow - suitable for SPAs
5. Authorization Code Grant Flow - suitable for Native Apps
6. Proof of Key Exchange (PKCE) flow - suitable for mobile apps

---

[ADAL - Azure AD Authentication Library](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-authentication-libraries)  

The Azure Active Directory Authentication Library (ADAL) v1.0 enables application developers to authenticate users to cloud or on-premises Active Directory (AD) and obtain tokens for securing API calls. ADAL makes authentication easier for developers through features such as:

- Configurable token cache that stores access tokens and refresh tokens
- Automatic token refresh when an access token expires and a refresh token is available
- Support for asynchronous method calls

---