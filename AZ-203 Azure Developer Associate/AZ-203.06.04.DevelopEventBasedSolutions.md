# AZ-203-06-04

### [Connect to and Consume Azure Services & Third-Party Services (20-25%)](https://www.microsoft.com/en-us/learning/exam-az-203.aspx)

1. [Develop event-based solutions](https://app.pluralsight.com/library/courses/microsoft-azure-enterprise-messaging-eventing/table-of-contents)

    - Implement solutions that use Azure Event Grid
    - Implement solutions that use Azure Notification Hubs
    - Implement solutions that use Azure Event Hub  

2. [Develop message-based solutions](https://app.pluralsight.com/library/courses/microsoft-azure-enterprise-messaging-eventing/table-of-contents)

    - Implement solutions that use Azure Service Bus
    - Implement solutions that use Azure Queue Storage queues

---

### Main Resources

- [Microsoft Azure Developer: Enterprise Messaging and Eventing (by Stephen W. Thomas)](https://app.pluralsight.com/library/courses/microsoft-azure-enterprise-messaging-eventing/table-of-contents)   

### Complementary Resources

---

## Goals for Enterprise Messaging and Eventing

1. Undestand the difference between messaging and eventing
2. Undestand the Azure Queueing technology options
3. How to make a single point connection from Azure into your Data Centre without a VPN or opening inbound firewall rules
4. How to capture large volumes of real-time events and display them insiade a power app#

## Azure Technologies for Enterprise Messaging and Eventing

1. Azure Sorage Queues
2. Azure Sercice Bus Queues
3. Azure Relay Service
4. Azure Event Grid
5. Azure Event Hub
6. Azure Notification Hubs

---

## Azure Enterprise Messaging and Eventing

**Azure Enterprise Messaging and Eventing** builds on three core technologies.

1. Queues

Queues are persistence stores to which messages can be sent and from which messages can be read.

2. Relay services

Azure Relay Service covers **the Cloud and On-Prem Hybrid scenarios** in which messages are exchaged between an datacenter in Azure and an on-premise datacenter. **Relay service** is not the only way in which this data exchange can be accomplished in Azure. However, it is a easy way in which this can be accomplished **securely**.

3. Event and Notifications

    - Azure Event Grid
    - Azure Event Hub
    - Azure Notification Hub

This is primarily powered by the **Azure Event Grid** which enables scenarios where consumers can be notified of events raised from within the Azure infrastructure. It is possible to raise either **Azure system events and custom events** i.e. in conjuction to the sale of a product.

---

# User Cases

## [Queues](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=1&mode=live)  

The main purpose of queues is to **provide a teporary storage** that sits **between** a set of message producers and a set of message consumers **in order to decouple them temporally**. 

Queues are **storage devices** for **heterogenous messages**. Messages with different schema are sent to a Queue provisioned in Azure and **stored** in it for a **maximum specified length of time** and in the order they are received. Consumers can read the messages from the queue **at the time the are able to do so** and draw only those messages which concern them. The queue can be set up to allow a single message to be read multiple times. 

It is offen encountered the situation in which the **rate at which messages are produced exceeds the rate at which consumers are able to process them**. This situation may arise when an the volume of messages being produced exceedes what is the norm or as a consequence of fewer consumers being available to process the messages. In other cases it might be that the time taken to produce the messages is inherently much shorter than the time required to process them and, of course, or all of these scenarios may happen together. In these cases queues can be used to **level out any temporary imbalance** between producers and consumers. 

#### Business Scenario for Queues

A business scenario may be the following. A large business might occasionally offer products on sales i.e. **on Black Friday**. This most likely might **trigger spikes** in sales and therefore in the the corresponding volume of messages sent to the backend consumers. 

#### Traditional Approach 

The **traditional solution** for this business scenario may be based on the following.

- An API to receive the messages
- SQL Server DB or similar persisted store to store the incoming messages.
- A Service that can asynchronously process the messages from reading them from the persistance layer first.

---

## [Relay Sevices](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=0&mode=live)    

**Relay Services** may be used to connect on-premise services to services in the cloud infrastructure and viceversa.
In other words, any time an organization wishes to send information resident on-premise to their cloud infrastructure and/or receive information from their cloud infrastructure into their on-premise network this can be achieved **securely** by employed Relay Services. The **very important distinctive characteristic of Relay Services over the traditional VPN solution** is that **Relay Services opens up only a single end point in the on-premise netwok and does so without requiring to punch a whole in the firewall of the VNET**.

### Typical Scenario for Hybrid Connection

#### Business Scenarios for Relay Services

#### Scenario 1 - propagation of information from one headquarters to another through the cloud infrastructure
A business owns and manage private IT infrstructure i.e. an on-premise network at one of his branch offices or headquarters. It wants to distrubute some files i.e. HR documentation, catalogs or similar
in a secure way which originate from these headquarters to the other headquarters and branch offices so that they may eventually reach their end users i.e. their employees.

One way to solve this problem inexpensively by leveraging Azure infrastructure is to use the Relay service. The headquarter that act as a source of the files to distribute will send the files to a Hybrid Connection endpoint in azure and the other headquarters and branch offices will then be able to read from the Hybrid Connection EP to retrieve the files. Notice that in both cases HTTP requests are made to the Hybrid Connection EP over HTTP and there is no need to open any port through any of the firewalls for inbound traffic.

Th Hybrid connection is paid per connection but a cheaper solution, when the volume of data is limited, is to use WCF Relay instead, although in this case only the WCF and the full .Net Framework is supported with corresponding SDKs.

#### Scenario 2 - to make available on-premise DB as a read-only copy available on the cloud 

Another similar but typical example is to make available a **SLQ Server from one branch office or headquarters to other**. The mechanism is the same as for the scenario just described only the nature of the data sent to and read from the Hybrid connection EP changes.

#### Traditional Approach 

The **traditional solution** for this business scenario may be based on the following.

- Use an **FTP** service to upload the files once a user has made a changes.
- Once in the cloud a service processes the file.
- Once the files is processed it may be stored to SQL or similar persistence layer.
- Other cloud services have access to the persistence layer thus the updated data.

---

## Events and Messaging

- Azure Event Grid
- Azure Event Hub    
- Azure Notification Hub

---

## [Azure Event Grid](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=1&mode=live)    

#### Business Scenario for EvenGrid

The business wishes to allow users of their software to make updates to their profile.
For example users are allowed to updated their profile image for their account among the others. This data is visible to the whole community this the business wishes to moderate and monitor changes to user account data in order to make sure that appropriate content is used i.e. that user images do not refer to product from the cometition and are appropriate, etc. 

In order to achive this the company needs to be able to **receive a notification when any specific piece of user accaount data changes**. The **notification** may also need to **make use of multiple channels** i.e. **email, sms, telephone call, etc**. **Notofication** might not anly be sent to specific personell but also to **other systems** for example other artifacts withing the company's cloud infrastructure.

#### Traditional Approach - Polling based system

As **real-time** motification system are very difficult to build the most traditional approach to solve to this type of problems is employ a **polling-based** system. For example, a .et Service that polls the user account information from the persistence layer and retrives the metadata about the updated data. **This .Net service** would laso be responsible for **maintaining a list of EPs that must to notified of any specific change as documented in the metadata**. 

This architecture that can of course work is also clearly **hard to maintain** and tends to break the Single Responsibility Principle (SRP). 

#### [EventGrid Approach](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=2&mode=live)  

**Azure EventGrid** can be employed in this scenario as a **serverless, open-platform, real-time event processing service built-in Azure designed to process notification messages at massive scale i.e. hundreds of thousands item-count and EPs**. It is capable of raising and processing notification between many of the Azure artifacts which in this context can be seen as **EventSources (Topics) & EventHandlers (Enet Subscriptions)**. 

The **message types** that can be raised by **EventSources (Topics)** depend on the specific topic that raises them but there are lots of predefined, built-in types already and custom topics and custom events are also possible. Altough, the types if the events changes they all share a **core schema** and each add to this core schema their own.

---

## [Azure EventHub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=0&mode=live)  

#### Business Scenario for EventHub

The business wishes to allow a variety of devices to send diagnostic messages i.e. about sales, visits, employees, premises, stocking levels, etc. which are collected from all over the several stores accross the country or even around the globe. This information **can amount to a very large data volume**.

The business needs that such **real-time data** is made available to a set of consumers within their Azure infrastructure and also outside of it i.e. by custom applications that are deployed on-premise, analysis services, etc.

#### [Traditional Approach](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=1&mode=live)   

One apprach to this business problem is **to create an API to receive the events produced by all the stores**. Clearly, this is a high challenge because the devices producing these information may be running on different platforms, stores are located in different geographical areas and information may be produced by them at differnt rates throught the course of the day, etc. **Building such API or even more a set of APIs to satisfy such requirement would be a real challenge**.

Moreover, **there would have to be somewhere to persist this data**

#### EventHub Approach 

Event Hubs are suitable for cases where **real-time data** must be **channelled** and **dispatched** to **multiple consumers** for example for analysis purposes. The data can be **channeled through an Azure Event Hub** and then **consumed** by all sort of **authorized** clients. The clients are set-up so that they know the **Azure Hub End Point** and posses the **the necessary connection string**. Clients connect to the Azure Hub in order to read the messages from it. 

Clients may be on-premise application which make use of the **Azure Event Hub SDK** as well as **other Azure Artifacts provisioned and managed by the business** or both i.e. one or more .Net Applications deployed on premise or something like **Stream Analytics** which may be set up in one of the business' subscriptions.

This mode of communication is tailored at

- High Volume of data
- Data that cam be sent packaged in messages of a maximum size of 64K which can be raiseed to 1MB by calling the Azure Customer Support.
- Situation in which the messages may originate from devices running on a number of platforms.
- Situations in shich devices running in different platform need to exchange messages.
- Situations where some kind of data agregation on real-time data needs to be performed i.e. via StreamAnalytics or PBI.

---

## [Azure Notification Hub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=0&mode=live)  

#### [Business Scenario for Notification Hub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=1&mode=live)  

The business needs to **push messages** to the devices owned by their customers which may run on a variety of platforms. The business needs to control when the contents of the notification messages and the time at which the notifications are pushed in order to drive sales i.e. by notifying their customers about products that are or will be on sales in stores nearby or that are within their likely interests. The business needs these messages to reach their customers in a timely manner that is with nop delay from the time the notification is raised. 

#### Traditional Approach 

There is no traditional approach to solve this problem as building **rea-time push notification systems is very challenging** and the traditional approach is to rely on third-party implementations. 

#### The Azure Notofication Hub Approach

**Azure Notification Hubs is a built-in push Notification System designed to send instant notifications to massive scale to almost any platform**.

---

## Azure Enterprise Messaging and Eventing Highlights

1. All technologies are desided to work cross-platform

**SDKs for the various platforms and programming languages (Python, C#, Java, etc.) are provided** to enable them to leverage this piece of Azure infrastructure.

2. Setting up Messaging and Eventing may take only minutes.

3. Very Low Cost and High Volume Enterprise messaging.

---

## Difference between Messaging and Events

### Messages

- The underlying technology employs some sort of **polling based mechanism** to check for the presence of messages. This results in a **delay** between the time at which the message is created and the time at which it is read by the consumer.

- The **payload of the message normally is the data** required by the consumer. This makes **messages heavy with respect to events**.

- The **sender** of the message is normally **aware of the nature of the recepient**.

### Events

- The technology si based on a **publish-subscribe** logic. This allows events to be **near real-time**.

- The payloads is normally **metadata** i.e. the location of the data related to teh event and not the data itself that is events are **light-weight**.

- Normally **event sources are ignorant of the subscribers**.

---

## Storage Queues

- This is the earliest Azure queueing technology.
- **Azure Sorage Queues** are **part of Azure Storage**.
- They are **lightweight queueing service**.
- They are accessable wia **RESP API**.
- Message size is limited to **64 KB**.
- The **retention** is **up yo 7 days**.
- Suitable for Azure-to-Azure hand-off.

## Service Bus Queues

- **Part of Azure Messaging**.
- **Part of** the **messages-based reliable messaging platform**.
- Service Bus Queues **exist within the Service Bus Namespace**.
- They offer a **true FIFO processing** solution.
- Maximum message size is **from 256KB to 1MB**.
- It is possible to enable **duplicate detection** on **inbound** messages.
- Have lots of optional enterprise features.
- Provide extensive SDK support for multi-platfrom.
- Supports **in-rder and at-most-once** message delivery.
- Provide **publish-subscribe** model.
- Have **Dead Letter Queue (DLQ)**
- Have **configurable message expiration**.

## [Topics and Subscriptions](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=7&mode=live)  

- Topics and Subscriptions are **extension features** to the **Azure Service Bus**.
- `The most important feature is the publish-subscribe` paradigm - this is what distiguishes Topics from plain messages on a Service Bus Queue.
- The **one-to-many** paradigm.
- **Message Properties routing** as `Rules & Actions`.

1. Use Azure CLI, Powershell or the Azure Portal to create **Topics & Subscription within a Azure Service Bus Namespace**.
2.`Rules for a Subscription` are **best** created in .Net code or a GUI such as the populat **Service Bus Explorer**.

### The important facts to keep in mind are

1. `Topics` are like any other messages on a Azure Service Bus Queue.
2. `Topics` have additional features in that **they can be subscribed to**.
3. `Topics` can be **sent to more than one subscriber at once**.
4. `Filters on a subscribed the Topic can be set to create rules` to route topics to subscriber based on the properties (but niot the payload) of the topic.
5. `Actions` can be set by subscribers **to adjust message properties** as rules are fired. For example if the filter rule on the topic's property named **OrderStatus** were 
`OrderStatus="new"` an `Action` could be set so that the value of the property `OrderStatus` for the received topic when the rule fires is ret to `OrderStatus=processed`. (This can be easily set up in **Azure Service Bus Explorer**)   

---

### [Demo - Creating & Working with Azure Topics & Subscriptions](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=8&mode=live)   

#### Highlights
1. Create a `Topic`.
2. Create Subscriptions for the Topic.
3. Create `Rules (Filters)` to route the Topic to specific subscriptions.


---

### Creation of a Sorage Queue

- [Demo - Creation of an Azure Storage Queue](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=3&mode=live)  

1. You can use any of **Azure CLI, Powershell or the Azure Portal**.
2. Must first already have or create a **Azure Storage Account** in whic the Storage Queue can be provisioned.
3. As anything else in Azure the storage account must be part of a **resource group and Azure subscription**.
4. From the **Overview** page of teh **storage account** select the **Queue option** to navigate to the pane where storage queues can be proviion for the storage account.

### How is it possible to interact with a Azure Storage Queue?

1. [Programmatically in your application by means of the **Azure Storage SDK** for your platform and programming language of choice](https://www.nuget.org/packages/WindowsAzure.Storage/). On Windows set the **connection string** in the **app.config** to that of your **Azure Storage Queue**. 

2. You may use the [**Azure Sorage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)    

3. Use **Azure Logic Apps** which can read and write messages to **Storage Queues**.

4. Use **Azure Functions**.

### Note - which Azure assents can belong to a Azure Storage Account?

1. Sorage Queues
2. Blobs
3. Files
4. Tables

---

## Creating and Working with a Storage Queue

- [Demo - Creating and Working with a Storage Queue](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=4&mode=live)    

In this demo you learn how

- Create a **Azure Storage Account**
- Provision a **Storage Queue** in the Sorage Account.
- What the **Storage Account Access Key and Connection String** are and where to find them in the portal
- How to use **Storage Explorer** to connect and interact with the Storage Account and Storage Queue i.e. by creating a new message in the Storage Queue.
- How to **set up a Logic App to act as a consumer of messages in the Storage Queue**.

---

## [Creating an Azure Service Bus Queue](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=5&mode=live)  

- [Demo - Creating and Working with Service Bus Queues](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=6&mode=live)  

1. Using the Azure Portal, Powershell or Azure CLI.
2. Create a **namespace** under **Service Bus**.
3. Add one or more **Azure Service Bus Queues** to the provisioned namespace.
4. Set the **access level** to either each individual queues or at the namespace level.

### How to interact with Azure Service Bus Queues

- [Use the **SDK** for your platform and language](https://www.nuget.org/packages/Microsoft.Azure.ServiceBus/). 
- Use any of the Azure features which can esily interact with Azure Service Bus Queues  
    - `Event Grid, Logic Apps, Azure Funtions, etc.`

- Use [Service Bus Explorer](https://github.com/paolosalvatori/ServiceBusExplorer)    

- [Demo - Creating & Working with Azure Service Bus Queues](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0f9a3869-e136-4df4-9639-c3a3d32ffe94&clip=6&mode=live)  

#### Resources 

- [Get started with Service Bus queues](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dotnet-get-started-with-queues)  

---

## [Relay Service - Hybrid Communication](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=0&mode=live)  

### Highlights 

- Azure Relay Service
- Hybrid Connection (an open protocol based on HTTP & WebSockets for mutli-platform scenarios)
- WCF Relay

---

### [Relay Services](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=2&mode=live)  

The **purpose and design** of Relay Services is to provide **secure connection to on-premise networks** `for` resources locate in Azure. The **aim** is to **establish a bidirectional communication channel between your on-premise network and Azure infrastructure** `without opening any port in the on-premise firewall to allow inbound traffic!`

Another **important fact** about relay service is that it is designed to establish a connection between resources located in the Azure infrastructure nad **a single endpoint in the on-premise netwrok** i.e. a SQL server or some other internal service.

### Relay Services are made of two core components

1. **Hybrid Connections** 

**Hybrid Connection** is a **open protocol** build upon **HTTP & Web Sockets**. It is designed to be multi-platform and supporst many programming languages. 

2. **WCF Relays**

This is a **legacy component** used only for WCF endpoints.

In both cases **SDKs** are available with support for all the major platforms and programming languages inthe namespace [**Microsoft.Azure.Relay**](https://www.nuget.org/packages/Microsoft.Azure.Relay).  

---

### [What is the difference between Azure Relay Services and VPN?](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=2&mode=live)    

| Azure Relay Services     | Traditional VPN             |
| ------------------------ | --------------------------- |
| No network configuration  | It requires much more configuration.|  
| EP are scoped to a single port on a single PC i.e. WCF Service or SQL Db | VPN are generally network-wide.|

---

### [What is the difference between Hyibrid Connection and WCF Relay?](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=2&mode=live)  

| Hybrid Connection        | WCF Relay                   |
| ------------------------ | --------------------------- |
| Charged per connection that is for the number of listeners as each requires a connection. | Charged per message thus cheaper on low message volumes.|
| Are Http & WebSocket based | Are based on WCF.|
| Have strong multi-platform support | only support WCF & .Net Framework.|


---

### [Creating an Azure Relay Service](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=3&mode=live)   

1. Create a **namespace** wich must be globally unique inside Azure.
2. Create a **Hybrid connection** or **WCF EP** in the namespace.

The namespace is created within a **subscription & resource group** and the 
**Authentication** is controlled via **Shared Access Policies** set at either **namespace level or connection level**.

- [Demo - Creating a Relay Namespace & Hybrid Connection & WCF Relays](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=8b69f14c-2ed2-4889-9a44-3c445ed2de96&clip=4&mode=live)   

The process of creation of a Hybrid connection results in a **Hybrid Connection URL** that is the End Point of the Hybrid Connection. If the Hybrid Connection has been created to make use of Authentication then **Acess Policies** must be created. However, it is also possible to create an EP that allows **anonymous access**.

One option is to **create two access policies**.

1. an access policy to listen for data sent from the EP.
2. an access policy to send data to the EP.

Notice that this guarantees that an **Hybrid Connection** supports **secure bidirectional communication** between Azure and any reource outsite it via a **single endpoint**. As the EP is reacheable over **HTTP** it is not necessary to open any ports through the on-premise firewall.

---

## [Events with Event Grid](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=0&mode=live)  

1. What is Azure Event Grid?
2. Working with built-in Events
3. Working with custome events

### [What is Azure Event Grid](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=2&mode=live)  

- A **real-tine** event processing system built into Azure
- It is desigend to run at **massive scale**
- It is designed to be **multi-platform** end **open** through custom events
- It is **serveless** which means that it is not necessary to provision ant resource and not even configure anything to use Event Grid

---

### Core Components of Azure Event Grid

1. Event Sources    (Topics)
2. Event Handlers   (Subscriptions)

**Event Sources** are **native components within Azure** that are capable of raising events for the Event Grid. It is also possible to **build custom topics** thus send events to the grid.

**Event subscribers** are Azure artifacts that **can be configured to automatically react** to events published by the Event Grid.

### Examples of Event Sources (Topics)

- Blod Storage
- Azure Subscription
- Media Services
- Resource Group
- Event Hub
- IoT Hub
- Service Bus
- Custom Topic

### Example of Event Handlers (Subscriptions)

- Azure Function
- Logic Apps
- AzureAutomation
- Web Hooks
- Queue Storage
- Hybrid Connections! (Relay Services)
- Event Hubs

---

### Type & Structure of Events

- There is a **core schema** for all types of the events 
- A part of the event schema that is not in the core schema is specific to the topic that raises it
- The **data object** is the part of the event schema that is publisher specific

---

### [What to do to get started with Event Grid](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=3&mode=live)  

1. Register Event Grid at **subscription level**

On the **Azure Portal** go to **Subscriptions** then **Resource Providers** the serach for **Event Grid** andd click register.

No other configuration is required. Once the subscription has the Event Grid enabled as one of its services you can begin to latch up azure conmponets within that subscription to the Event Grid as publisher and/or subscriber.

---

### [Custom Apps subscribing to Internal Azure Events](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=4&mode=live)  

- [Demo](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=0588df39-38a5-4547-a83f-37cbd1350757&clip=5&mode=live)   

---

## Event Grid Custom Events

1. Define the event specific part of schema for the custom event.
2. **Create a Topic** to which the events will be **sent** and which will **raise** the event to notify its subscribers.
3. Add subcribers to the Topic as needed.
4. Foe each subscriber you can determine the **retry logic** and the **action** to take once the retry allowance is exceeded i.e. deadqueueing the
event.

### The Event's Topic

You **must** create an Azure object named **Topics** for your custom events to wwork with. When the Topic is created it is **associated with a HTTP End Point**. It is this EP that is used to send the custom events to. When the 
Topic receives the events at its EP then it raises them for all its subscribers.

This infrastructure is designed this way because the EP of the Topic can be secured by **Access Policy** as part of the Topic. This means that in order to send valid events to the Topic's EP an application must know the EP **and** the **shared acess key** for the EP. Clearly, only the creator of the Topic and/or EP can know and convey this information making the EP secure and derby the cutom events.  

#### Create the Topic

1. Go to the **Azure Portal**.
2. Navigate to **Azure Event Grid Topics**.
3. **Add** a Topic - the filed **DNSName** is tye name of the Topic.
4. You mostly leave the other fields to their default.
5. **Create** the Topic.

#### Add a subscriptions to the Topic

1. Go to the **Azure Portal**.
2. Navigate to the Event Grid Topic
3. **Add Subscription**
4. Provide the **End Point details of the Subriber** i.e. `WebHook, Storage Queue, Event Hub, Hybrid Connection (Relay Service)`
5. Provode an **Event Subscription Name**
6. Create
7. Adjust **Properties & Features** of the subscription i.e. **retry policy**.

#### Send events to the Topic

In order to send custom events to a Topic you can use any of the following.

1. Powershell
2. Azure CLI
3. Net Code
4. Other Azure Artifacts i.e. LogicApps.

#### Send events to the Topic with a LogicApp

1. In the Azure Portal Navigate to the LogicApp pane
2. Select the LogicApp designer
3. Select `New Step` then type in `event` and select the `Azure Event Grid Publish`
4. Select `Publish Event`
5. Provide the `Connection Name, Topic Endpoint (DNS) and Shared Access Signature (SAK)` that are required by this step of this LogicApp to send messages to the Custom Topic. The `Connection Name` is any name you like, the `Topic Endpoint (DNS) and Shared Access Signature (SAK)`  are found in the pane `Event Grid Topics` in the secions `overview` and `Access Key` for the specific topic to which the events are to be sent to i.e. the custom topic you have created earlier.
6. Once all the data to connect the LogicApp to the Event Grid Topic is provided the `Create Event` button can be used to edit an event to be published by the LogicApp to the Event Grid Topic.
7. Some of the event data is part of the **core data of any event** but teh field **data** is where the **data with the Topic's specific scheme** can be typed in. 
8. Run the LogicApp to publish the defined custom event to the Event Grid Custom Topic.

#### Check the flow of data through a (custom) Topic

1. From the Azure Portal in `Event Grid Topics` pane in the `Overview` section, plots relative to all defined Topics in the Azure Event Grid within the given subscription are shown with the staistics and details of teh messages sent to and leaving from each Topic.

---

## [Event Hub - Massive Event Stream Processing with Azure](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=0&mode=live) 

- [What an Azure Event Hub is](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=2&mode=live)  
- Creating an Event Hub
- Write Data to and Read Data From an Azure Event Hub
- Use Stream Analytics with Azure Event Hub
- Draw Data from Event Hub into Power BI

---

### [What is an Azure Event Hub?](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=2&mode=live)  

- **real-time event processing** cloud service.
- can handle **a stream of millions of vents per seconds** i.e. from devices.
- offers a **open, multi-platform ecosystem** to allow any kind of client to send messages to the Hub.
- offers a **temporary retention for messages up to 7 days** in **Azure Storage**. 
- offers **fast integration with other Azure services such as StreamAnalytics**.

### [Why would you use an Azure Event Hub?](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=2&mode=live)  

- Thanks to the SDKs it is easy to write code on any device and/or platform to send events to an Azure Event Hub.
- Azure Event Hub is **serverless** that is there is nothing to provision that is users of the Event Hub are not required to provision any Azure artifacts to start using Azure Event Hub. Conversely, for a VM there are several  Azure artifacts that are required together with it such as VNet, Subnets, NSG, etc. Event Hub is built straight into the Azure Infrastructure and can be consumed as a service following a minimal amount of set-up and configuration. 
- There are **numerous output options** that is a multitude of event consumers that can process the event data.
- It is a **pay-as-you-go service**.

### [What is the difference between Azure Event Hub and IoT Hub?](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=3&mode=live) 

| Azure Evernt Hub         | Azure IoT Hub             |
| ------------------------ | --------------------------- |
| Transaction volume sized per second   | Transaction volume sized per day |  
| Cheaper by a factor of 50 | Expensive |
| Provides one-way communitcation | Provides two-way communication with devices |
| Have a limit of 5000 AMQP connections | ? |
| - | IoT Hub supports device management |
| - | IoT Hub supports individual device  authentication |
| - | IoT Hub supports MQTT Proocol for devices |

#### Some References on Event Hub Communication Protocols
 
- [AMQP 1.0 in Azure Service Bus and Event Hubs protocol guide](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-amqp-protocol-guide)  
- [Advanced Message Queuing Protocol AMQP](https://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf) connection.
- [Reference - choose a communication protocol](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-protocols)

---

### [Demo - Creating a Namespace, an Event Hub and sending events](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=6&mode=live)    

---

## Features of Namespaces & Event Hubs

### Part 1 - Create a Namespace

1. Create a Namespace with globally unique name inside Azure.
2. Choose whether the Azure Namespace should be created to be Zone Redundant.
3. Select the pricing tier BASIC or STANDARD.
4. Enable the **auto-inflate feature** if you need to temporarely increase the TUs (**does not auto-deflate!**).

#### Zone Redundant Namespaces

A **Namespace** may be set to be **Zone Redundant** when it is first created. The advantage of zone redundancy ius that the Azure artifacts that are created within a zone redundant namespace may be located across **different Azure Availability Zone**. An **Azure Availability Zone** is a physical location within a **Azure Region** thus **Zone Redundancy** allows **assets to be located in different datacenters within the same Azure Region**. For each **Azure Region** there exist **a minimun of three Azure Zones**.

### Part 2 - Create Create one or more Event Hubs inside the Namespace

1. Set the **partition count** to up to 32 (soft limit, cannot be changed).
2. Set the **message retention and capture**.

#### Event Hub Partition Count

**Azure Event Hub Partitions** is a **parallelization feature** that allow an event Hub **Azure Event Hub** to increase its TUs processing power. For example, a single Azure Event Hub in a Namespace has **1 TU = 1 MB/s or 1000 Event/s ingress** limit. However, the Namespace has a limit of 20 thus by setting the partition count of te Event Hub to 2 the TUs of the Hub become 2. 

#### Event Hub Message Retention & Capture

The **basic message retention** of an Azure Event Hub is **1 day** but it can be increased to **7 days**. However, the **message retention** must be such to remain within the **84 GB** limit if the whole Namespace. One possibility to increase message retention is also to store messages to soem other form of storage such as any of teh the other storage artifacts SLQ Db, Azure Table,Storage Queue, etc. 

**Capture** is the feature of na Event Hub that allows it to **automatically** write message to any of teh following storage artifacts.

- Azure Storage Account.
- Azure Dat Lake Service Account in Apache Avro format.

---

### Namespaces Limits

It is possible to create as many Azure Event Hubs as necesssary within the same namespace. However, the **Throughput Units & Sotre Capacity limits are set on the Namespace and not on the individual Hubs**. 

#### Event Hub & Namespace Throughput Units (TU)

- 1 TU = 1 MB/s or 1000 Event/s ingress 
- 2 TU = 2 MB/s  or 2000 Event/s engress
- 1 TU = 84 GB of event storage for 64KB * 1 day retention
- max 20 TU/namespace (soft limit)


| Azure Evernt Hub         | Azure IoT Hub             |
| ------------------------ | --------------------------- |
| Transaction volume sized per second   | Transaction volume sized per day |  
| Cheaper by a factor of 50 | Expensive |
| Provides one-way communitcation | Provides two-way communication with devices |
| Have a limit of 5000 AMQP connections | ? |
| - | IoT Hub supports device management |
| - | IoT Hub supports individual device  authentication |
| - | IoT Hub supports MQTT Proocol for devices |

---

### [How to write events to an Azure Event Hub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=e031b223-991d-4e85-85e2-0b4269563200&clip=5&mode=live)    

Enents are written to an Azure Event Hub as **HTTP POST or  Advanced Message Queueing Protocol 1.0 (AMQP) connection**.
Thanks to the **SDKs** it is possible to write evnets to an Event Hub on almost any device and platform combination. **SDKs** are available for the following languages. 

- .Net
- Java
- C
- Go
- Python
- Node.js
- [Apache Kafka](https://kafka.apache.org/) (?)

In the .Net ecosystem all that is requireed is to install the following **NuGet Packages**. 

| .Net Core         | .Net Framework                                |
| ------------------------ | -------------------------------------- |
| Microsoft.Azure.EventHubs NuGet Package | WindowsAzure.ServiceBus |

The following is a sample to show how easy it is to post events to an Event Hub. There exist a number of methods to post events to an Azure Event Hub in different ways but the principle is the same for all as illustrated below. 

```
using Microsoft.Azure.EventHubs;

var hubConnectionString = ...
var eventHubClient = EventHubCleint.CreateFromConnectionString( hubConnectionString);

var message = @"somemessage";
await eventHubClient.SendAsync(new EventData(Encoding.UTF8.GetBytes(message)));
await eventHubClient.CloseAsync();

```

---

## [Azure Notification Hub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=0&mode=live)  

**Azure Notification Hubs is a built-in push Notification System designed to send instant notifications to massive scale to almost any platform**.

### [Main Features of Azure Notification Hubs](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=2&mode=live)  

- Push Notification Ssystem built in Azure
- Designed for massive scale i.e. millions of devices
- Designed for instant notification delivery 
- Notifications can target any device and any Platform
- Notification can be **target** to devices on the bases of **location and tagging** 
- Provide an abstraction over **Push Notification Systems (PNS)**
- Has **Templates for Localization** of the notifications to tailor the contnts based on the user's preferences

### [Push Notfication Platforms supported by Azure Notification Hubs](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=2&mode=live)  

- iOS - Apple Push Notification (APN)
- Android - Google Cloud Messaging (GCM)
- Windows - Windows Push Notification (WNS)
- Kindle - Amazon Device Messaging (ADM)
- Baidu - Baidu Push Notification SDK
- Push Notofication to the Chrome Browser
- Push Notification to Windows Desktop
- Others less common PNSs

---

### [How to Create an Azure Notification Hubs](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=3&mode=live)  

1. Create a new **Namespace** (or target an existing one) in which to create the Notificatiuon Hub
2. Provide a name for the NH
3. Select the Subscription
4. Select the **Pricing Tier** (Free,Basic,Standard)  
5. **Set up a PNS Connection**

### [PNS Connection](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=3&mode=live)    
A PNS Connection is used by the Azure Event Hub to know where to send the notifications. The target of an Azure Notification Hub is an **EP** exposed by a **PNS Provider** which makes available for such EP some form of **API Key or OAuth Details**, these details must be made available to the Azure Notification Hub to know where the notification must be sent. On the other end of the chain there are the applications or services running on the OS of the target devices which must also be linked up to the EP exposed by the PNS Provider. When both the Azure Notification Hub and the applications or services are set up to make use of the EP as described then the Azure Notification Hub can push nessages to the EP and the EP relays them to the devices.

### [Demo - Creating an Azure Notification Hub](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=4&mode=live)  

### [Targetting based on Location & Tags](https://app.pluralsight.com/player?course=microsoft-azure-enterprise-messaging-eventing&author=stephen-thomas&name=fe597018-c7c0-4ebe-867c-62985cf3c108&clip=5&mode=live)  

In order to make use of this feature the **Azure Notification Hubs SDK** should be used. Thanks to the SDK sending a notification is as simple as in the code exerpt below. The notification sent to the Notification Hub in this case has a **tag** thus only the **subscribers to the notification hub for that tag will receive the notification**.

```
var toast = @"<toats>...</toast>"
var tag = @"Microsoft";
outcome = await Notifications.Instance.Hub.SendWindowsNativeNotificationAsync(toast,tag);
```

---